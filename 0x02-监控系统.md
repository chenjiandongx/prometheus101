## 2. 监控系统

### 2.1 监控的目标

技术的进步永远是依靠需求来推动的，监控系统需要解决什么问题决定了它的技术发展方向。我们的目标是：

* **实时反馈系统当前状态**：监控某个硬件或某个系统，都需要能实时看到当前系统的状态，是正常、异常、或者故障。
* **保证业务持续稳定运行**：监控的目的就是要保证系统、服务、业务正常运行，即使出现故障也能第一时间接收到故障报警，在第一时间处理解决，从而保证业务持续性的稳定运行。

监控是服务于系统和业务的，是为了提高系统的鲁棒性，辅助我们更好的掌握系统和服务的当前状态。

监控的核心可归纳为四点：

1. 发现问题：当系统发生故障报警，我们会收到故障报警的信息。
2. 定位问题：告警信息里面一般会有错误的原因，我们需要对报警内容进行分析，定位产生故障具体原因。
3. 解决问题：当分析完故障的原因后，就需要通过故障解决的优先级去修复问题。
4. 总结问题：当我们解决完重大故障后，需要对故障原因以及防范进行总结归纳，避免以后重复出现。

### 2.2 监控的维度和流程

#### 2.2.1 监控维度

* **网络**：网络协议：http、dns、tcp、icmp；网络硬件：路由器，交换机等。
* **磁盘**：资源用量。
* **主机**：资源用量。
* **容器**：资源用量。
* **应用**：延迟，错误，QPS，内部状态等。
* **中间件**：资源用量，以及服务状态。
* **编排工具**：集群资源用量，调度等。

#### 2.2.1 监控流程

一般来讲，通用的监控流程可以分为以下几点：

1. 数据采集：数据采集对应服务端来说，可能是主动的也可能是被动的（pull/push）。
2. 数据存储：采集到的样本数据应该落实到本地或远程持久化存储。
3. 数据分析和展示：提供数据分析工具以及 dashboard 界面，使开发者可以更直观地分析问题。
5. 监控报警：可以根据开发者提供的自定义告警规则自动监控系统行为，一旦符合规则就发送对应告警信息给接受者。
6. 报警处理：排查并处理故障问题。

### 2.3 四个黄金信号

Google 的 Google SRE Books 一书中提出了系统监控的四个黄金信号，这个四个黄金信号在任何系统中都是很好地反应系统的性能问题，因此被称为「黄金信号」。

#### 2.3.1 Latency（延迟）

延迟是发起一次服务请求所需要的时间，但是需要明白，成功请求的延迟和失败请求的延迟是需要区分开的。例如由于与数据库或其他关键后端服务的连接断开而触发的 HTTP 500 错误可能很快就会得到解决，但是由于 HTTP 500 错误表示请求失败，因此将所有的 500 错误都计入整体延迟可能会导致计算结果出现较大误差。

除此以外，在微服务中通常提倡“快速失败”，开发人员需要特别注意这些延迟较大的错误（可能是 SQL 中的慢查询），因为这些缓慢的错误会明显影响系统的性能，因此追踪这些错误的延迟也是非常重要的。

#### 2.3.2 Traffic（通讯量）

通讯量是一种对系统需求的度量单位，流量对于不同类型的系统而言可能代表不同的含义。

* Web 服务：每秒 HTTP 请求数。
* 音频流系统：网络 I/O 情况。
* 数据库：查询和写入频率。

#### 2.3.3 Errors（错误）

错误是监控当前系统所有发生的错误请求，用于衡量当前系统错误发生的速率。对于失败的请求而言，大部分是显式的（HTTP 500），而有些是隐式（HTTP 200，实际业务流程依然是失败的）。

显式的错误如 HTTP 500 可通过在负载均衡器（如 Nginx）上进行捕获，而对于一些系统内部的异常，则可能需要直接从服务中添加钩子统计并进行获取（日志输出）。

#### 2.3.4 Saturation（饱和度）

饱和度主要强调最能影响服务状态的受限制的资源。如果系统主要受内存影响，那主要关注系统的内存状态，如果系统主要受限与磁盘 I/O，则主要观测磁盘 I/O 的状态。

通常情况下，当这些资源达到饱和后，服务的性能会明显下降，会出现比较明显的瓶颈。同时还可以利用饱和度对系统做出预测，比如「磁盘是否可能在 4 个小时候就满了」。

### 2.4 RED 法则

在「四个黄金信号」的原则下，RED 方法可以有效的帮助用户衡量云原生以及微服务应用下的用户体验问题。

* **Rate（速率）**：服务每秒接收的请求数。
* **Errors（错误）**：每秒失败的请求数。
* **Duration（耗时）**：每个请求的耗时。

### 2.5 USE 法则

USE，全称（Utilization Saturation and Errors Method），主要用于分析系统性能问题，可以指导用户快速识别资源瓶颈以及错误的方法。

#### 2.5.1 Utilization（使用率）

使用率主要关注系统资源的使用情况。这里的资源主要包括但不限于：CPU、内存、网络、磁盘等。100% 的使用率通常是系统性能瓶颈的标志。

#### 2.5.2 Saturation（饱和度）

饱和度例如 CPU 的平均运行排队长度，任何资源在某种程度上的饱和都可能导致系统性能的下降。

#### 2.5.3 Errors（错误）

错误指的是错误计数。例如「网卡在数据包传输过程中检测到的以太网网络冲突了 14 次」，「数据库连接在 5 分钟中断开了 3 次」。
